#! /bin/bash

PKGNAME=${1:-}
set -u
# try to guess EL version
ELVERS=$(rpm --eval "%{rhel}")
RPMTD=$(rpm --showrc |grep _topdir | grep -v '{_topdir}' | awk '{print $3}')
RPMBUILD_DIR=$(rpm --eval "${RPMTD}")

if [[ ${PKGNAME} == "icingadb-redis" ]] ; then
  sed -i  s/BUILD.icingadb-redis.*-build\'/BUILD\'/  ${RPMBUILD_DIR}/SPECS/${PKGNAME}.spec
  sed -i  s,'/usr/lib/rpm/rpmuncompress -x -v','tar xvf',  ${RPMBUILD_DIR}/SPECS/${PKGNAME}.spec
  sed -i  s,'BuildRequires: tcl8','BuildRequires: tcl',  ${RPMBUILD_DIR}/SPECS/${PKGNAME}.spec
  # Check for version
  PKGVER=$(grep ^Version ~/rpmbuild.el9.x86_64/SPECS/icingadb-redis.spec |awk '{print $2}')
  V1=$(echo ${PKGVER} | cut -d \. -f 1-2)
  SUB=$(echo ${PKGVER} | cut -d \. -f 3)

  if [[ "${V1}" == "8.2" ]] && [[ ${SUB} -gt 3 ]] ;  then
    ed ${RPMBUILD_DIR}/SPECS/${PKGNAME}.spec << END
30i

%global debug_package %{nil}
.
w
q
END
  fi
  # continue
fi
